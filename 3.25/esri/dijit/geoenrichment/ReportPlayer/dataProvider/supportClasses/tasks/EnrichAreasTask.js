// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.25/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/tasks/EnrichAreasTask","dojo/_base/declare dojo/_base/lang esri/kernel esri/SpatialReference esri/graphic ../GEUtil ../AnalysisAreaUtil esri/dijit/geoenrichment/utils/GeometryUtil".split(" "),function(m,f,n,h,p,q,r,k){function l(){var a=n.id.credentials[0];return a&&a.token}return m(null,{enrichAreas:function(a){var b={};b.studyAreas=this._analysisAreasToStudyAreas(a.analysisAreas,a.countryID,a.comparisonLevels);a.report?b.analysisVariables=
[{itemid:a.report.reportID,url:a.report.portalUrl,token:l(),outFields:["*"]}]:a.fields&&(b.analysisVariables=a.fields);return this._doRunTask(b,a,"enrich")},createReport:function(a){var b={f:"bin",format:"xml",reportfields:{}};b.report={itemid:a.report.reportID,url:a.report.portalUrl,token:l()};b.studyAreas=this._analysisAreasToStudyAreas(a.analysisAreas,a.countryID);return this._doRunTask(b,a,"createReport")},_analysisAreasToStudyAreas:function(a,b,e){var d=this,c=[];a=a.map(function(a){if(a.geographies&&
a.geographies.length)return d._studyAreaFromGeographies(a.geographies,b,!0);c.push(a.feature);return{analysisArea:a}});c=this._generalizeFeatures(c);a=a.map(function(a){if(a.analysisArea){var b=c.shift();return{attributes:f.mixin({},b.attributes,d._getStorePointForArea(a.analysisArea)),geometry:b.geometry.toJson()}}return a});e&&(e=e.map(function(a){return{layer:a}}),a.forEach(function(a){a.comparisonLevels=e}));a.forEach(function(a,b){a.attributes&&(a.attributes.STORE_ID=b)});return a},_getStorePointForArea:function(a){return(a=
a.additionalFeatures&&a.additionalFeatures.filter(function(a){return"point"===a.geometry.type})[0])&&r.geometryToLatLong(a.geometry)},_generalizeFeatures:function(a,b){b=void 0!==b?b:0;if(b=k.needGeneralizeGeometry(a,0<b?3*b:-3,0))a=a.map(function(a){return new p(a.geometry,a.symbol,a.attributes)}),k.generalizeGeometry(a,b,0);return a},createFeatureForGeographies:function(a,b){a={returnGeometry:!0,outSR:new h(102100),studyAreas:[this._studyAreaFromGeographies(a,b.countryID,!0)],dataCollections:["GlobalIntersect"]};
return this._doRunTask(a,b,"enrich")},_studyAreaFromGeographies:function(a,b,e){b={sourceCountry:b,layer:null,ids:null,attributes:null};var d=null,c=[],g;a.forEach(function(a){if(!a||!a.id)throw Error("Wrong geography.");var b=a.levelId;if(b)if(!d)d=b;else if(d!==b)throw Error("Geographies have different level IDs.");c.push(a.id);a.attributes&&(g=f.mixin(g||{},a.attributes))});b.layer=d;b.ids=e?[c.join(",")]:c;b.attributes=g;return b},createFeatureForBuffer:function(a,b){a={returnGeometry:!0,outSR:new h(102100),
dataCollections:["GlobalIntersect"],studyAreasOptions:{bufferUnits:a.units,bufferRadii:[a.radius],areaType:"RingBuffer"},studyAreas:[{geometry:a.point.toJson?a.point.toJson():a.point}]};return this._doRunTask(a,b,"enrich")},_doRunTask:function(a,b,e){a=f.mixin({f:"json",useData:{sourceCountry:b.countryID,hierarchy:b.hierarchy||"census"},forStorage:!1},a);for(var d in a){var c=a[d];"object"===typeof c&&(a[d]=JSON.stringify(c))}return q[e](b.geoenrichmentUrl,a)}})});